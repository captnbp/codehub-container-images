stages:
  - test
  - build
  - scan
  - sign

include:
  - project: doca/gitlab-ci-lib
    file: container/build.yaml
  - project: doca/gitlab-ci-lib
    file: container/sign.yaml
  - project: doca/gitlab-ci-lib
    file: container/test.yaml

lint-dockerfile-code-server:
  extends: .tpl:container:test:hadolint
  variables:
    DOCKERFILE_PATH: code-server/Dockerfile

lint-dockerfile-nginx:
  extends: .tpl:container:test:hadolint
  variables:
    DOCKERFILE_PATH: nginx/Dockerfile

lint-dockerfile-oauth:
  extends: .tpl:container:test:hadolint
  variables:
    DOCKERFILE_PATH: oauth/Dockerfile

docker-build-code-server:
  extends: .tpl:container:build:kaniko
  variables:
    IMAGE_NAME: "code-server"

docker-build-nginx:
  extends: .tpl:container:build:kaniko
  variables:
    IMAGE_NAME: "nginx"

docker-build-oauth:
  extends: .tpl:container:build:kaniko
  variables:
    IMAGE_NAME: "oauth"

container_scanning-code-server:
  extends: .tpl:container:test:cve
  variables:
    IMAGE_NAME: "code-server"
  needs:
    - docker-build-code-server

container_scanning-nginx:
  extends: .tpl:container:test:cve
  variables:
    IMAGE_NAME: "nginx"
  needs:
    - docker-build-nginx

container_scanning-oauth:
  extends: .tpl:container:test:cve
  variables:
    IMAGE_NAME: "oauth"
  needs:
    - docker-build-oauth

sign-code-server:
  extends: .tpl:container:sign:sign-image
  variables:
    IMAGE_NAME: "code-server"
  needs:
    - docker-build-code-server

sign-nginx:
  extends: .tpl:container:sign:sign-image
  variables:
    IMAGE_NAME: "nginx"
  needs:
    - docker-build-nginx

sign-oauth:
  extends: .tpl:container:sign:sign-image
  variables:
    IMAGE_NAME: "oauth"
  needs:
    - docker-build-oauth

attest-code-server:
  extends: .tpl:container:sign:attest-image
  variables:
    IMAGE_NAME: "code-server"
  needs:
    - docker-build-code-server

attest-nginx:
  extends: .tpl:container:sign:attest-image
  variables:
    IMAGE_NAME: "nginx"
  needs:
    - docker-build-nginx

attest-oauth:
  extends: .tpl:container:sign:attest-image
  variables:
    IMAGE_NAME: "oauth"
  needs:
    - docker-build-oauth

mr-note-code-server:
  extends: .tpl:container:test:mr-note
  variables:
    IMAGE_NAME: "code-server"
  needs:
    - docker-build-code-server

mr-note-nginx:
  extends: .tpl:container:test:mr-note
  variables:
    IMAGE_NAME: "nginx"
  needs:
    - docker-build-nginx

mr-note-oauth:
  extends: .tpl:container:test:mr-note
  variables:
    IMAGE_NAME: "oauth"
  needs:
    - docker-build-oauth